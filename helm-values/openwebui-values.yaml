# OpenWebUI Helm Chart Values
# Helm repo: https://helm.openwebui.com/

# Pin to official image for stability
image:
  repository: ghcr.io/open-webui/open-webui
  tag: "0.7.2@sha256:16d9a3615b45f14a0c89f7ad7a3bf151f923ed32c2e68f9204eb17d1ce40774b"
  pullPolicy: IfNotPresent

# Connect to LiteLLM as OpenAI-compatible backend
openaiBaseApiUrls:
  - "http://litellm.litellm.svc.cluster.local:4000/v1"

# API key from ExternalSecret
extraEnvVars:
  # NOTE: OpenWebUI will NOT use this master-key anymore in JWT mode
  # Instead, it will pass the user's Okta JWT token to LiteLLM
  # Keeping this for backward compatibility during transition
  - name: OPENAI_API_KEY
    valueFrom:
      secretKeyRef:
        name: openwebui-secrets
        key: openai-api-key

  # Webui secret key for session encryption
  - name: WEBUI_SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: openwebui-secrets
        key: webui-secret-key

  # OAuth/OIDC Configuration - Okta SSO
  - name: OAUTH_PROVIDER
    value: "oidc"

  - name: OAUTH_PROVIDER_NAME
    value: "Okta"

  - name: OPENID_PROVIDER_URL
    valueFrom:
      secretKeyRef:
        name: openwebui-secrets
        key: okta-openid-url

  - name: OAUTH_CLIENT_ID
    valueFrom:
      secretKeyRef:
        name: openwebui-secrets
        key: okta-client-id

  - name: OAUTH_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: openwebui-secrets
        key: okta-client-secret

  - name: OAUTH_SCOPES
    value: "openid email profile groups"

  # Auto-provision users on first Okta login
  - name: ENABLE_OAUTH_SIGNUP
    value: "true"

  # Disable password-based authentication (OAuth only)
  - name: ENABLE_PASSWORD_AUTH
    value: "false"

  # Enable Okta group synchronization for RBAC
  - name: ENABLE_OAUTH_GROUP_MANAGEMENT
    value: "true"

  # OAuth role mapping (map Okta groups to OpenWebUI roles)
  # Format: okta-group:openwebui-role
  - name: OAUTH_ROLES_CLAIM
    value: "groups"

  # Admin users (comma-separated emails)
  - name: ADMIN_EMAIL
    valueFrom:
      secretKeyRef:
        name: openwebui-secrets
        key: admin-email

# Disable bundled Ollama (using LiteLLM instead)
ollama:
  enabled: false

# Disable bundled Pipelines
pipelines:
  enabled: false

# Persistence on EBS with gp3 storage class (PoC: reduced size)
persistence:
  enabled: true
  size: 5Gi
  storageClass: gp3
  accessModes:
    - ReadWriteOnce

# Internal service only (no public ingress)
service:
  type: ClusterIP
  port: 80

# No ingress - access via port-forward from bastion
ingress:
  enabled: false

# Resource limits (PoC: reduced resources)
resources:
  requests:
    cpu: "100m"
    memory: "256Mi"
  limits:
    cpu: "500m"
    memory: "1Gi"

# Liveness and readiness probes
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /health/db
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5

# Node selector (optional - for cost optimization)
# nodeSelector:
#   node.kubernetes.io/instance-type: t3.medium

# Pod annotations for monitoring
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"

# Pod security context
podSecurityContext:
  fsGroup: 1000

# Container security context (OPA compliant)
containerSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false  # OpenWebUI needs to write temp files
  capabilities:
    drop:
      - ALL

# Standard Kubernetes labels (OPA compliant)
labels:
  app.kubernetes.io/name: open-webui
  app.kubernetes.io/version: "v0.6.41"
  app.kubernetes.io/component: frontend
  app.kubernetes.io/part-of: litellm-stack
