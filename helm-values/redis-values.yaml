# DandyDeveloper Redis HA Helm Chart Values
# Helm repo: https://dandydeveloper.github.io/charts
# Chart: redis-ha (replaces Bitnami redis which is now behind paywall)

# Pin image version for stability
image:
  repository: redis
  tag: "8.4.0-alpine@sha256:6cbef353e480a8a6e7f10ec545f13d7d3fa85a212cdcc5ffaf5a1c818b9d3798"

# Number of redis master/slave pods (PoC: single instance)
replicas: 1

# Redis configuration
redis:
  port: 6379
  masterGroupName: "mymaster"
  config:
    maxmemory-policy: "volatile-lru"
  # Liveness and readiness probes
  livenessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
  readinessProbe:
    enabled: true
    initialDelaySeconds: 5
    periodSeconds: 10
  # Resource limits for redis container
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

# Authentication using ExternalSecret
auth: true
existingSecret: redis-credentials
authKey: redis-password

# Sentinel configuration for automatic failover (PoC: quorum 1)
sentinel:
  port: 26379
  quorum: 1

# Persistence on EBS with gp3 storage class (PoC: reduced size)
persistentVolume:
  enabled: true
  size: 4Gi
  storageClass: gp3
  accessModes:
    - ReadWriteOnce

# High availability - spread pods across nodes (PoC: disabled)
hardAntiAffinity: false

# Pod disruption budget
podDisruptionBudget:
  maxUnavailable: 1

# HAProxy for load balancing (recommended for external access)
haproxy:
  enabled: false  # Using Sentinel-aware clients directly

# Prometheus metrics (using official quay.io image)
exporter:
  enabled: true
  image: quay.io/oliver006/redis_exporter@sha256:bac9872da2b48e6eebbffb11517a5dcda59958eda51e1e4231eeb5dd516b4a5f
  tag: v1.80.1
  port: 9121
  serviceMonitor:
    enabled: true
    namespace: monitoring
    labels:
      release: kube-prometheus

# Network policy (optional - enable for enhanced security)
networkPolicy:
  enabled: false

# Pod security context
securityContext:
  runAsUser: 1000
  fsGroup: 1000
  runAsNonRoot: true

# Container security context (OPA compliant)
containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false  # Redis needs to write data
  runAsNonRoot: true
  runAsUser: 1000
  capabilities:
    drop:
      - ALL

# Standard Kubernetes labels (OPA compliant)
labels:
  app.kubernetes.io/name: redis
  app.kubernetes.io/version: "7.4.1-alpine"
  app.kubernetes.io/component: cache
  app.kubernetes.io/part-of: litellm-stack
