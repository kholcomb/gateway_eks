apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sAllowedRepos
metadata:
  name: allowed-image-repos
  annotations:
    description: >-
      Only allow images from approved container registries.
      This prevents deploying potentially malicious or unvetted images.
spec:
  # Start in dryrun mode to audit without blocking
  # Change to "deny" after validating existing workloads comply
  enforcementAction: dryrun
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
      - apiGroups: ["apps"]
        kinds: ["Deployment", "DaemonSet", "StatefulSet", "ReplicaSet"]
    # Exclude system namespaces
    excludedNamespaces:
      - kube-system
      - kube-public
      - gatekeeper-system
  parameters:
    repos:
      # Official LiteLLM images (exact org match)
      - "ghcr.io/berriai"
      # OpenWebUI (exact org match)
      - "ghcr.io/open-webui"
      # Redis
      - "docker.io/library/redis"
      # Bitnami images (common for Helm charts, exact org match)
      - "docker.io/bitnamilegacy"
      # Prometheus/Grafana stack (exact org matches)
      - "quay.io/prometheus"
      - "docker.io/grafana"
      - "quay.io/prometheus-operator"
      # Jaeger (exact org match)
      - "docker.io/jaegertracing"
      # External Secrets Operator (exact org match)
      - "ghcr.io/external-secrets"
      # AWS EKS add-ons (ECR region-specific, exempt in exemptImages below)
      - "602401143452.dkr.ecr"
      - "public.ecr.aws"
      # Pause container (exact registry match)
      - "registry.k8s.io"
      # Customer ECR repositories (MCP servers and custom images)
      # NOTE: Replace ACCOUNT_ID with your actual AWS account ID (e.g., 123456789012)
      #- "ACCOUNT_ID.dkr.ecr"
    exemptImages:
      # AWS CNI and other EKS system images
      - "602401143452.dkr.ecr.*.amazonaws.com/*"
